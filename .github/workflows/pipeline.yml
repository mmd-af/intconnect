name: IaC and Deployment Pipeline

on:
  push:
    branches:
      - main
      - staging

jobs:
  terraform-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - run: |
          mkdir -p ~/.terraform.d/
          echo '{"credentials":{"app.terraform.io":{"token":"${{ secrets.TERRAFORM_CLOUD_TOKEN }}"}}}' > ~/.terraform.d/credentials.tfrc.json

      - env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_TOKEN }}
        run: terraform -chdir=terraform init

      - env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_hetzner_server_type: ${{ vars.HETZNER_SERVER_TYPE }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_hetzner_ssh_key_name: ${{ secrets.HETZNER_SSH_KEY_NAME }}
        run: terraform -chdir=terraform plan

      - env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_zone_id: ${{ vars.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_hetzner_server_type: ${{ vars.HETZNER_SERVER_TYPE }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_hetzner_ssh_key_name: ${{ secrets.HETZNER_SSH_KEY_NAME }}
        run: terraform -chdir=terraform apply -auto-approve

      - run: |
          ip=$(terraform -chdir=terraform output -raw server_ip)
          echo "SERVER_IP=$ip" >> $GITHUB_ENV

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - run: |
          OWNER="${{ github.repository_owner }}"

          if [ "${{ github.ref_name }}" = "main" ]; then
            COMPOSE_FILE="docker-compose.prod.yml"
            ENV_SECRET="ENV_FILE_PRODUCTION"
            ENV_PATH="src/.env"
            PHP_REPO="intconnect-prod"
            NGINX_REPO="intconnect-nginx-prod"
          else
            COMPOSE_FILE="docker-compose.staging.yml"
            ENV_SECRET="ENV_FILE_STAGING"
            ENV_PATH="src/.env.staging"
            PHP_REPO="intconnect-stg"
            NGINX_REPO="intconnect-nginx-stg"
          fi

          echo "ENV_FILE_PATH=$ENV_PATH" >> $GITHUB_ENV
          echo "ENV_FILE_SECRET_NAME=$ENV_SECRET" >> $GITHUB_ENV
          echo "COMPOSE_FILE_PATH_REMOTE=$COMPOSE_FILE" >> $GITHUB_ENV
          echo "PHP_IMAGE=ghcr.io/${OWNER}/${PHP_REPO}:latest" >> $GITHUB_ENV
          echo "NGINX_IMAGE=ghcr.io/${OWNER}/${NGINX_REPO}:latest" >> $GITHUB_ENV

          CONTENT=$(cat "$COMPOSE_FILE" | sed "s|\${GITHUB_USERNAME}|$OWNER|g")
          echo "$CONTENT" > /tmp/compose.yml

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.prod
          push: true
          tags: ${{ env.PHP_IMAGE }}

      - uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/Dockerfile.nginx
          push: true
          tags: ${{ env.NGINX_IMAGE }}

      - run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key

          SSH="ssh -i ~/.ssh/key -o StrictHostKeyChecking=no ubuntu@${{ env.SERVER_IP }}"
          APP="/home/ubuntu/intconnect"

          $SSH "mkdir -p $APP/src"

          $SSH "cat > $APP/${{ env.ENV_FILE_PATH }}" << 'EOF'
          ${{ secrets[env.ENV_FILE_SECRET_NAME] }}
          EOF

          cat /tmp/compose.yml | $SSH "cat > $APP/${{ env.COMPOSE_FILE_PATH_REMOTE }}"

          $SSH << EOF
            cd $APP
            echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            sudo docker compose -f "${{ env.COMPOSE_FILE_PATH_REMOTE }}" pull
            sudo docker compose -f "${{ env.COMPOSE_FILE_PATH_REMOTE }}" up -d --remove-orphans
            EOF

          rm ~/.ssh/key
