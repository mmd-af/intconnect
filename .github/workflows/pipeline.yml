name: IaC and Deployment Pipeline
'on':
  push:
    branches:
      - main
      - staging
jobs:
  terraform-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      - name: Configure Terraform Cloud credentials
        run: >
          mkdir -p ~/.terraform.d/

          echo '{"credentials":{"app.terraform.io":{"token":"${{
          secrets.TERRAFORM_CLOUD_TOKEN }}"}}}' >
          ~/.terraform.d/credentials.tfrc.json
      - name: Terraform init
        env:
          HCLOUD_TOKEN: '${{ secrets.HETZNER_TOKEN }}'
        run: terraform -chdir=terraform init
      - name: Terraform plan
        env:
          HCLOUD_TOKEN: '${{ secrets.HETZNER_TOKEN }}'
          CLOUDFLARE_API_TOKEN: '${{ secrets.CLOUDFLARE_API_TOKEN }}'
          TF_VAR_cloudflare_zone_id: '${{ vars.CLOUDFLARE_ZONE_ID }}'
          TF_VAR_cloudflare_account_id: '${{ secrets.CLOUDFLARE_ACCOUNT_ID }}'
          TF_VAR_hetzner_server_type: '${{ vars.HETZNER_SERVER_TYPE }}'
          TF_VAR_ssh_public_key: '${{ secrets.SSH_PUBLIC_KEY }}'
          TF_VAR_hetzner_ssh_key_name: '${{ secrets.HETZNER_SSH_KEY_NAME }}'
        run: terraform -chdir=terraform plan
      - name: Terraform apply
        env:
          HCLOUD_TOKEN: '${{ secrets.HETZNER_TOKEN }}'
          CLOUDFLARE_API_TOKEN: '${{ secrets.CLOUDFLARE_API_TOKEN }}'
          TF_VAR_cloudflare_zone_id: '${{ vars.CLOUDFLARE_ZONE_ID }}'
          TF_VAR_cloudflare_account_id: '${{ secrets.CLOUDFLARE_ACCOUNT_ID }}'
          TF_VAR_hetzner_server_type: '${{ vars.HETZNER_SERVER_TYPE }}'
          TF_VAR_ssh_public_key: '${{ secrets.SSH_PUBLIC_KEY }}'
          TF_VAR_hetzner_ssh_key_name: '${{ secrets.HETZNER_SSH_KEY_NAME }}'
        run: terraform -chdir=terraform apply -auto-approve
      - name: Get server IP
        run: |
          ip=$(terraform -chdir=terraform output -raw server_ip)
          echo "SERVER_IP=$ip" >> $GITHUB_ENV
      - name: Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GITHUB_TOKEN }}'
      - name: Set deployment variables
        run: >
          OWNER="${{ github.repository_owner }}"


          if [ "${{ github.ref_name }}" = "main" ]; then
            COMPOSE_FILE="docker-compose.prod.yml"
            REMOTE_ENV_PATH="src/.env"
            PHP_REPO="intconnect-prod"
            NGINX_REPO="intconnect-nginx-prod"
          else
            COMPOSE_FILE="docker-compose.staging.yml"
            REMOTE_ENV_PATH="src/.env.staging"
            PHP_REPO="intconnect-stg"
            NGINX_REPO="intconnect-nginx-stg"
          fi


          echo "COMPOSE_FILE=$COMPOSE_FILE" >> $GITHUB_ENV

          echo "REMOTE_ENV_PATH=$REMOTE_ENV_PATH" >> $GITHUB_ENV

          echo "PHP_IMAGE=ghcr.io/${OWNER}/${PHP_REPO}:latest" >> $GITHUB_ENV

          echo "NGINX_IMAGE=ghcr.io/${OWNER}/${NGINX_REPO}:latest" >>
          $GITHUB_ENV


          CONTENT=$(sed "s|\${GITHUB_USERNAME}|${OWNER}|g" "$COMPOSE_FILE")

          echo "$CONTENT" > /tmp/compose.yml
      - name: Build & push PHP image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.prod
          push: true
          tags: '${{ env.PHP_IMAGE }}'
      - name: Build & push Nginx image
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/Dockerfile.nginx
          push: true
          tags: '${{ env.NGINX_IMAGE }}'
      - name: Deploy to server
        run: >
          mkdir -p ~/.ssh

          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key

          chmod 600 ~/.ssh/key


          APP="/home/ubuntu/intconnect"

          SERVER="ubuntu@${{ env.SERVER_IP }}"

          SSH="ssh -i ~/.ssh/key -o StrictHostKeyChecking=no $SERVER"

          SCP="scp -i ~/.ssh/key -o StrictHostKeyChecking=no"


          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "${{ secrets.ENV_FILE_PRODUCTION }}" | sed -e 's/\$/\$\$/g' > /tmp/envfile
          else
            echo "${{ secrets.ENV_FILE_STAGING }}" | sed -e 's/\$/\$\$/g' > /tmp/envfile
          fi


          $SSH "mkdir -p $APP/src"


          # write env both to src/.env (for app) and root .env (for
          docker-compose variable expansion)

          $SCP /tmp/envfile $SERVER:$APP/${{ env.REMOTE_ENV_PATH }}

          $SCP /tmp/envfile $SERVER:$APP/.env


          # upload compose file

          $SCP /tmp/compose.yml $SERVER:$APP/${{ env.COMPOSE_FILE }}


          # deploy

          $SSH << EOF
            set -e
            cd $APP
            echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            sudo docker compose -f "${{ env.COMPOSE_FILE }}" pull
            sudo docker compose -f "${{ env.COMPOSE_FILE }}" up -d --remove-orphans
          EOF


          rm -f ~/.ssh/key /tmp/envfile
